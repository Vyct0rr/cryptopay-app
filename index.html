<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CryptoPay</title>
    <style>
        /* CORE STYLES */
        :root {
            --primary: #4F46E5;
            --bg: #F3F4F6;
            --white: #ffffff;
            --text-dark: #1F2937;
            --text-gray: #6B7280;
            --success: #10B981;
            --danger: #EF4444;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text-dark); padding-bottom: 90px; }
        
        /* UTILITIES */
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .p-4 { padding: 16px; }
        .mb-4 { margin-bottom: 16px; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .text-xl { font-size: 1.25rem; }
        .text-sm { font-size: 0.875rem; }
        .text-gray { color: var(--text-gray); }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        
        /* COMPONENTS */
        .card { background: var(--white); border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 15px; }
        
        .btn { border: none; padding: 14px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%; font-size: 1rem; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { border: 1px solid #E5E7EB; background: white; color: var(--text-gray); }
        .btn-outline.active { border-color: var(--primary); color: var(--primary); background: #E0E7FF; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-gray); }
        .input-field { width: 100%; padding: 14px; border: 1px solid #E5E7EB; border-radius: 12px; font-size: 1rem; outline: none; background: #F9FAFB; }
        .select-field { width: 100%; padding: 14px; border: 1px solid #E5E7EB; border-radius: 12px; font-size: 1rem; background: #fff; }

        /* NAV & HEADER */
        header { background: var(--white); padding: 15px 20px; position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; border-bottom: 1px solid #E5E7EB; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--white); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #E5E7EB; z-index: 20; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; color: #9CA3AF; text-decoration: none; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 4px; }

        /* HOME SPECIFIC */
        .balance-card { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; text-align: center; padding: 35px 20px; border-radius: 24px; margin-bottom: 25px; }
        .balance-amount { font-size: 2.5rem; font-weight: 800; margin: 10px 0; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .action-btn { background: var(--white); padding: 16px; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-decoration: none; color: var(--text-dark); }
        .recent-tx-item { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid #F3F4F6; }

        /* PAY GRID */
        .pay-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .pay-item { background: white; padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        .pay-icon { font-size: 2rem; margin-bottom: 10px; display: block; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; justify-content: center; align-items: flex-end; }
        .modal-sheet { background: white; width: 100%; padding: 25px; border-radius: 24px 24px 0 0; animation: slideUp 0.3s ease; max-height: 80vh; overflow-y: auto; }
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }

        /* RECEIPT MODAL */
        #receipt-modal { align-items: center; }
        .receipt-content { background: white; width: 85%; padding: 30px; border-radius: 20px; text-align: center; animation: popUp 0.3s ease; }
        @keyframes popUp { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
    </style>
</head>
<body>

    <div id="loading-msg" style="padding: 40px; text-align: center; color: var(--text-gray);">
        <h2>‚ö†Ô∏è Initializing...</h2>
        <p>If this stays for more than 5 seconds, the code may be incomplete.</p>
        <button onclick="localStorage.clear(); location.reload()" style="margin-top:20px; padding:10px; background:#eee; border:none; border-radius:8px;">Force Reset Data</button>
    </div>

    <header id="main-header" style="display:none">
        <div class="font-bold text-xl">CryptoPay</div>
        <div onclick="resetApp()" style="width:35px; height:35px; background:#E0E7FF; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--primary); font-weight:bold;">JD</div>
    </header>

    <main id="app-content" class="p-4"></main>

    <div id="bill-modal" class="modal-overlay" onclick="if(event.target === this) closeBillModal()">
        <div class="modal-sheet">
            <h2 id="bill-title" class="font-bold text-xl mb-4">Pay Bill</h2>
            <div class="input-group">
                <label id="bill-label">Phone Number</label>
                <input type="tel" id="bill-target" class="input-field" placeholder="080...">
            </div>
            <div class="input-group">
                <label>Amount (NGN)</label>
                <input type="number" id="bill-amount" class="input-field" placeholder="1000">
                <div class="text-xs text-gray mt-2">Bal: ‚Ç¶<span id="bill-balance"></span></div>
            </div>
            <button class="btn btn-primary" onclick="processBill()">Pay Now</button>
        </div>
    </div>

    <div id="deposit-modal" class="modal-overlay" onclick="if(event.target === this) closeDepositModal()">
        <div class="modal-sheet">
            <h2 class="font-bold text-xl mb-4">Add Money</h2>
            <div class="input-group">
                <label>Source</label>
                <select class="select-field">
                    <option>Bank Card (**** 1234)</option>
                    <option>Bank Transfer</option>
                </select>
            </div>
            <div class="input-group">
                <label>Amount (NGN)</label>
                <input type="number" id="deposit-amount" class="input-field" placeholder="50000">
            </div>
            <button class="btn btn-success" onclick="processDeposit()">Fund Wallet</button>
        </div>
    </div>

    <div id="receipt-modal" class="modal-overlay">
        <div class="receipt-content">
            <div style="font-size: 4rem; margin-bottom: 10px">‚úÖ</div>
            <h2 class="font-bold text-xl">Success!</h2>
            <p id="receipt-msg" class="text-gray mt-4">Transaction Completed</p>
            <button class="btn btn-primary mt-4" onclick="closeReceipt()">Done</button>
        </div>
    </div>

    <nav id="main-nav" class="bottom-nav" style="display:none">
        <a href="#" class="nav-item active" onclick="router('home')"><span class="nav-icon">üè†</span>Home</a>
        <a href="#" class="nav-item" onclick="router('pay')"><span class="nav-icon">üì±</span>Pay</a>
        <a href="#" class="nav-item" onclick="router('send')"><span class="nav-icon">üí∏</span>Send</a>
        <a href="#" class="nav-item" onclick="router('swap')"><span class="nav-icon">üîÑ</span>Swap</a>
        <a href="#" class="nav-item" onclick="router('wallet')"><span class="nav-icon">üíº</span>Wallet</a>
    </nav>

    <script>
        // --- SAFEGUARD: SHOW UI ---
        document.getElementById('loading-msg').style.display = 'none';
        document.getElementById('main-header').style.display = 'flex';
        document.getElementById('main-nav').style.display = 'flex';

        // --- DATA & STATE ---
        const defaultState = {
            wallets: { NGN: 25000.00, USDC: 100.00 },
            rates: { USDC_NGN: 1500 }, 
            history: [
                { type: 'Welcome', desc: 'Account Created', amount: '', date: 'Nov 20' }
            ]
        };

        let state = JSON.parse(JSON.stringify(defaultState));
        let sendMode = 'wallet'; 
        let activeBillType = '';

        // Load State Safely
        try {
            const saved = localStorage.getItem('cryptopayState_v5');
            if(saved) {
                const parsed = JSON.parse(saved);
                // Basic integrity check
                if(parsed.wallets && typeof parsed.wallets.NGN === 'number') {
                    state = parsed;
                }
            }
        } catch(e) {
            console.log("State reset due to error");
        }

        function saveState() {
            localStorage.setItem('cryptopayState_v5', JSON.stringify(state));
        }

        // --- ROUTER ---
        function router(screen) {
            try {
                const app = document.getElementById('app-content');
                if(!app) return;
                
                // Nav Styles
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const activeNav = document.querySelector(`.nav-item[onclick="router('${screen}')"]`);
                if(activeNav) activeNav.classList.add('active');

                // Render
                if (screen === 'home') renderHome(app);
                else if (screen === 'pay') renderPay(app);
                else if (screen === 'send') renderSend(app);
                else if (screen === 'swap') renderSwap(app);
                else if (screen === 'wallet') renderWallet(app);

            } catch(e) {
                alert("Screen Error: " + e.message);
            }
        }

        // --- SCREENS ---
        function renderHome(container) {
            const usdc = state.wallets.USDC || 0;
            const ngn = state.wallets.NGN || 0;
            const rate = state.rates.USDC_NGN || 1500;
            const totalUSD = usdc + (ngn / rate);
            const totalNGN = (usdc * rate) + ngn;
            
            container.innerHTML = `
                <div class="balance-card">
                    <div class="text-sm" style="opacity: 0.9">Total Net Worth</div>
                    <div class="balance-amount">$${totalUSD.toFixed(2)}</div>
                    <div class="text-sm">‚âà ‚Ç¶${totalNGN.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                </div>

                <div class="action-grid">
                    <a class="action-btn" onclick="router('send')">
                        <span style="font-size: 1.5rem">üì§</span><span class="font-bold text-sm">Send</span>
                    </a>
                    <a class="action-btn" onclick="router('pay')">
                        <span style="font-size: 1.5rem">üßæ</span><span class="font-bold text-sm">Pay</span>
                    </a>
                    <a class="action-btn" onclick="openDepositModal()">
                        <span style="font-size: 1.5rem">‚ûï</span><span class="font-bold text-sm">Add Money</span>
                    </a>
                </div>

                <h3 class="font-bold mb-2">Recent Activity</h3>
                ${(state.history || []).map(tx => `
                    <div class="recent-tx-item">
                        <div>
                            <div class="font-bold">${tx.type}</div>
                            <div class="text-xs text-gray">${tx.desc}</div>
                        </div>
                        <div class="font-bold ${tx.amount.includes('-') ? 'text-danger' : 'text-success'}">${tx.amount}</div>
                    </div>
                `).join('')}
            `;
        }

        function renderPay(container) {
            container.innerHTML = `
                <h2 class="font-bold text-xl mb-4">Pay Bills</h2>
                <div class="card flex items-center justify-between" style="padding:15px">
                     <div>
                        <div class="font-bold">Scan to Pay</div>
                        <div class="text-xs text-gray">Merchants & POS</div>
                     </div>
                     <div style="font-size:2rem">üì∑</div>
                </div>

                <h3 class="font-bold mt-4">Utilities</h3>
                <div class="pay-grid">
                    <div class="pay-item" onclick="openBillModal('Airtime')">
                        <span class="pay-icon">üì±</span><div class="font-bold text-sm">Airtime</div>
                    </div>
                    <div class="pay-item" onclick="openBillModal('Data')">
                        <span class="pay-icon">üì∂</span><div class="font-bold text-sm">Data Bundle</div>
                    </div>
                    <div class="pay-item" onclick="openBillModal('Electricity')">
                        <span class="pay-icon">üí°</span><div class="font-bold text-sm">Electricity</div>
                    </div>
                    <div class="pay-item" onclick="openBillModal('TV')">
                        <span class="pay-icon">üì∫</span><div class="font-bold text-sm">Cable TV</div>
                    </div>
                </div>
            `;
        }

        function renderWallet(container) {
            container.innerHTML = `
                <h2 class="font-bold text-xl mb-4">My Assets</h2>
                <div class="card flex justify-between items-center mb-3">
                    <div>
                        <div class="font-bold text-xl">üá≥üá¨ NGN</div>
                        <div class="text-xs text-gray">Fiat Balance</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-xl">‚Ç¶${state.wallets.NGN.toLocaleString()}</div>
                        <button class="btn btn-outline" style="padding:5px 10px; margin-top:5px; font-size:0.8rem" onclick="openDepositModal()">+ Add Money</button>
                    </div>
                </div>
                <div class="card flex justify-between items-center">
                    <div>
                        <div class="font-bold text-xl">üá∫üá∏ USDC</div>
                        <div class="text-xs text-gray">Stablecoin</div>
                    </div>
                    <div class="font-bold text-xl">$${state.wallets.USDC.toFixed(2)}</div>
                </div>
            `;
        }

        function renderSend(container) {
            const isBank = sendMode === 'bank';
            container.innerHTML = `
                <h2 class="font-bold text-xl mb-4">Send Money</h2>
                <div class="flex mb-4">
                    <button class="btn btn-outline ${!isBank ? 'active' : ''}" style="margin-right:10px; flex:1" onclick="setSendMode('wallet')">To Wallet</button>
                    <button class="btn btn-outline ${isBank ? 'active' : ''}" style="flex:1" onclick="setSendMode('bank')">To Bank</button>
                </div>
                
                <div class="card">
                    ${isBank ? `
                        <div class="input-group">
                            <label>Select Bank</label>
                            <select id="bankName" class="select-field"><option>GTBank</option><option>Access Bank</option><option>OPay</option></select>
                        </div>
                        <div class="input-group">
                            <label>Account Number</label>
                            <input type="number" id="acctNum" class="input-field" placeholder="0123456789">
                        </div>
                        <div class="input-group">
                            <label>Amount (NGN)</label>
                            <input type="number" id="sendAmount" class="input-field" placeholder="5000">
                            <div class="text-xs text-gray mt-2">Available: ‚Ç¶${state.wallets.NGN.toLocaleString()}</div>
                        </div>
                    ` : `
                        <div class="input-group">
                            <label>Username</label>
                            <input type="text" id="username" class="input-field" placeholder="@username">
                        </div>
                        <div class="input-group">
                            <label>Amount (USDC)</label>
                            <input type="number" id="sendAmount" class="input-field" placeholder="10.00">
                            <div class="text-xs text-gray mt-2">Available: $${state.wallets.USDC.toFixed(2)}</div>
                        </div>
                    `}
                    <button class="btn btn-primary mt-4" onclick="processSend()">${isBank ? 'Send to Bank' : 'Send Crypto'}</button>
                </div>
            `;
        }

        function renderSwap(c) {
             c.innerHTML = `
                <h2 class="font-bold text-xl mb-4">Swap Crypto</h2>
                <div class="card">
                    <div class="input-group">
                        <label>From (NGN)</label>
                        <input type="number" id="swapAmt" class="input-field" placeholder="0.00" oninput="calcSwap()">
                        <div class="text-xs text-gray mt-1">Bal: ‚Ç¶${state.wallets.NGN.toLocaleString()}</div>
                    </div>
                    <div class="text-center my-2">‚¨áÔ∏è</div>
                    <div class="input-group">
                        <label>To (USDC)</label>
                        <input type="text" id="swapOut" class="input-field" disabled placeholder="0.00">
                    </div>
                    <button class="btn btn-primary" onclick="processSwap()">Swap Now</button>
                </div>`;
        }

        // --- LOGIC: BILLS & DEPOSIT ---
        function openDepositModal() {
            document.getElementById('deposit-modal').style.display = 'flex';
        }
        function closeDepositModal() {
            document.getElementById('deposit-modal').style.display = 'none';
        }
        function processDeposit() {
            const amt = parseFloat(document.getElementById('deposit-amount').value);
            if(!amt || amt <= 0) return alert("Enter valid amount");
            
            state.wallets.NGN += amt;
            state.history.unshift({ type: 'Deposit', desc: 'Card Funding', amount: `+‚Ç¶${amt.toLocaleString()}`, date: 'Just Now' });
            saveState();
            closeDepositModal();
            showReceipt(`Funded ‚Ç¶${amt.toLocaleString()}`);
        }

        function openBillModal(type) {
            activeBillType = type;
            document.getElementById('bill-title').textContent = `Pay ${type}`;
            document.getElementById('bill-label').textContent = type === 'Electricity' ? 'Meter Number' : 'Phone Number';
            document.getElementById('bill-balance').textContent = state.wallets.NGN.toLocaleString();
            document.getElementById('bill-modal').style.display = 'flex';
        }
        function closeBillModal() {
            document.getElementById('bill-modal').style.display = 'none';
        }
        function processBill() {
            const amt = parseFloat(document.getElementById('bill-amount').value);
            const target = document.getElementById('bill-target').value;
            
            if(!amt || !target) return alert("Fill all details");
            if(amt > state.wallets.NGN) return alert("Insufficient Balance");

            state.wallets.NGN -= amt;
            state.history.unshift({ type: 'Bill Pay', desc: `${activeBillType} - ${target}`, amount: `-‚Ç¶${amt.toLocaleString()}`, date: 'Just Now' });
            saveState();
            closeBillModal();
            showReceipt(`Paid ‚Ç¶${amt} for ${activeBillType}`);
        }

        // --- OLD LOGIC ---
        function setSendMode(mode) { sendMode = mode; router('send'); }
        function calcSwap() {
            const val = parseFloat(document.getElementById('swapAmt').value);
            if(val) document.getElementById('swapOut').value = (val / state.rates.USDC_NGN).toFixed(2);
        }
        function processSwap() {
            const amt = parseFloat(document.getElementById('swapAmt').value);
            if(!amt || amt > state.wallets.NGN) return alert("Invalid Amount");
            const recv = amt / state.rates.USDC_NGN;
            state.wallets.NGN -= amt;
            state.wallets.USDC += recv;
            state.history.unshift({ type: 'Swap', desc: 'NGN to USDC', amount: `+${recv.toFixed(2)} USDC`, date: 'Just Now' });
            saveState();
            showReceipt(`Swapped ‚Ç¶${amt} to $${recv.toFixed(2)}`);
        }
        function processSend() {
            const amt = parseFloat(document.getElementById('sendAmount').value);
            if(!amt) return alert("Enter valid amount");
            if(sendMode === 'bank') {
                if(amt > state.wallets.NGN) return alert("Insufficient Funds");
                state.wallets.NGN -= amt;
                state.history.unshift({ type: 'Transfer', desc: 'To Bank', amount: `-‚Ç¶${amt.toLocaleString()}`, date: 'Just Now' });
                showReceipt(`Sent ‚Ç¶${amt} to Bank`);
            } else {
                if(amt > state.wallets.USDC) return alert("Insufficient Funds");
                state.wallets.USDC -= amt;
                state.history.unshift({ type: 'Sent', desc: 'To User', amount: `-$${amt}`, date: 'Just Now' });
                showReceipt(`Sent $${amt} to User`);
            }
            saveState();
        }

        function showReceipt(msg) {
            document.getElementById('receipt-msg').textContent = msg;
            document.getElementById('receipt-modal').style.display = 'flex';
        }
        function closeReceipt() {
            document.getElementById('receipt-modal').style.display = 'none';
            router('home');
        }
        function resetApp() {
            if(confirm("Reset all data?")) { localStorage.removeItem('cryptopayState_v5'); location.reload(); }
        }

        // Init
        setTimeout(() => router('home'), 100);

    </script>
</body>
</html>
